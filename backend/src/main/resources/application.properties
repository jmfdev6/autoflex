# Application
quarkus.application.name=autoflex-backend
quarkus.application.version=1.0.0

# API Path - Prefixo para todas as rotas REST (versionado em v1)
# Pode ser configurado via variável de ambiente API_PATH
quarkus.resteasy-reactive.path=${API_PATH:/api/v1}

# Server
quarkus.http.port=8081
# Cloud Run usa porta 8080 e pode ser configurada via variável PORT
# Tentar múltiplas formas de ler a porta: PORT, QUARKUS_HTTP_PORT, ou propriedade do sistema
%prod.quarkus.http.port=${PORT:${QUARKUS_HTTP_PORT:8080}}
# Cloud Run requer bind em todas as interfaces (0.0.0.0), não apenas localhost
%prod.quarkus.http.host=0.0.0.0
# CORS está sendo gerenciado pelo HttpAuthFilter (suporta wildcard ex: https://*.vercel.app).
# Desabilitar CORS nativo do Quarkus para evitar que o preflight seja respondido sem os headers corretos.
quarkus.http.cors=false
%prod.quarkus.http.cors=false

# Mantendo as configurações para referência dos filtros customizados
# Define a origem permitida (sua URL do Vercel)
# IMPORTANTE: Evite usar "*" se estiver usando autenticação/cookies
quarkus.http.cors.origins=http://localhost:5173,http://localhost:3000,http://localhost:8080
# CORS para produção: use wildcard para não precisar mudar a cada vercel --prod
# Com https://*.vercel.app qualquer URL do Vercel (incl. previews) é aceita.
# Se definir CORS_ORIGINS no Cloud Run, inclua o wildcard: https://*.vercel.app
%prod.quarkus.http.cors.origins=${CORS_ORIGINS:https://*.vercel.app}

# Define os métodos permitidos (usado pelos filtros customizados)
quarkus.http.cors.methods=GET,PUT,POST,DELETE,OPTIONS,PATCH

# Define os cabeçalhos que o front-end pode enviar (usado pelos filtros customizados)
quarkus.http.cors.headers=accept,authorization,content-type,x-requested-with,access-control-request-method,access-control-request-headers,origin

# Se o seu front-end envia credenciais (cookies ou headers de auth), habilite isso:
quarkus.http.cors.access-control-allow-credentials=true

# Opcional: define por quanto tempo o navegador deve "lembrar" dessa permissão (cache do preflight)
quarkus.http.cors.access-control-max-age=24H

# JWT Configuration
# Public key for JWT verification (RS256)
mp.jwt.verify.publickey.location=classpath:/publicKey.pem
mp.jwt.verify.issuer=autoflex-backend
# Private key for JWT signing (used by AuthService)
autoflex.jwt.privatekey.location=classpath:/privateKey.pem
# Enable JWT support
quarkus.smallrye-jwt.enabled=true

# JWT Token Settings
autoflex.jwt.issuer=autoflex-backend
autoflex.jwt.access-token.duration=3600
autoflex.jwt.refresh-token.duration=86400

# Authentication Settings
autoflex.auth.admin.username=${ADMIN_USERNAME:admin}
autoflex.auth.admin.password=${ADMIN_PASSWORD:admin123}

# Cache Configuration
quarkus.cache.enabled=true
# Products cache: 5 minutes TTL
quarkus.cache.products.expire-after-write=5m
# Product by code cache: 10 minutes TTL
quarkus.cache.product-by-code.expire-after-write=10m
# Raw materials cache: 5 minutes TTL
quarkus.cache.raw-materials.expire-after-write=5m
# Raw material by code cache: 10 minutes TTL
quarkus.cache.raw-material-by-code.expire-after-write=10m

# Logging
quarkus.log.level=INFO
quarkus.log.category."com.autoflex".level=DEBUG
# Logging detalhado durante startup para debug (produção)
%prod.quarkus.log.category."io.quarkus".level=INFO
%prod.quarkus.log.category."org.jboss".level=INFO

# Logging Format - JSON para produção, texto para desenvolvimento
%dev.quarkus.log.console.json=false
%prod.quarkus.log.console.json=true

# Logging Pattern
quarkus.log.console.format=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{2.}] (%t) %s%e%n

# Database - PostgreSQL (Development)
%dev.quarkus.datasource.db-kind=postgresql
%dev.quarkus.datasource.username=autoflex
%dev.quarkus.datasource.password=autoflex123
%dev.quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/autoflex
%dev.quarkus.hibernate-orm.database.generation=drop-and-create
%dev.quarkus.hibernate-orm.log.sql=true

# Database - PostgreSQL (Docker Compose)
%docker.quarkus.datasource.db-kind=postgresql
%docker.quarkus.datasource.username=${DB_USERNAME:autoflex}
%docker.quarkus.datasource.password=${DB_PASSWORD:autoflex123}
%docker.quarkus.datasource.jdbc.url=${DB_URL:jdbc:postgresql://postgres:5432/autoflex}
%docker.quarkus.hibernate-orm.database.generation=drop-and-create
%docker.quarkus.hibernate-orm.log.sql=true

# Database - PostgreSQL (Production - GCP Cloud Run)
%prod.quarkus.datasource.db-kind=postgresql
%prod.quarkus.datasource.username=${DB_USERNAME:autoflex}
%prod.quarkus.datasource.password=${DB_PASSWORD}
%prod.quarkus.datasource.jdbc.url=${DB_URL}
%prod.quarkus.hibernate-orm.database.generation=none
%prod.quarkus.hibernate-orm.log.sql=false
# Otimizações para startup mais rápido
%prod.quarkus.hibernate-orm.metrics.enabled=false
%prod.quarkus.datasource.jdbc.initial-size=1
%prod.quarkus.datasource.jdbc.min-size=1
%prod.quarkus.datasource.jdbc.max-size=5

# Flyway Database Migrations
quarkus.flyway.migrate-at-start=true
quarkus.flyway.locations=classpath:db/migration
# Baseline: permite que Flyway assuma controle de um banco já existente
# Cria a tabela flyway_schema_history se não existir e marca o estado atual como baseline
quarkus.flyway.baseline-on-migrate=true
%prod.quarkus.flyway.migrate-at-start=${FLYWAY_ENABLED:true}
%dev.quarkus.flyway.migrate-at-start=true
# Timeout para migrações Flyway em produção (evitar timeout no startup)
%prod.quarkus.flyway.connect-retries=3
%prod.quarkus.flyway.connect-retries-interval=10

# Database - PostgreSQL (Tests)
# Desabilitar DevServices para testes (não requer Docker)
# Se o banco não estiver disponível, os testes serão pulados
%test.quarkus.datasource.devservices.enabled=false
%test.quarkus.datasource.devservices.postgresql.enabled=false

# Hibernate
quarkus.hibernate-orm.packages=com.autoflex.entity
quarkus.hibernate-orm.dialect=org.hibernate.dialect.PostgreSQLDialect

# Jackson
quarkus.jackson.fail-on-unknown-properties=false

# Health Check
quarkus.smallrye-health.root-path=/health
quarkus.smallrye-health.liveness-path=/health/live
quarkus.smallrye-health.readiness-path=/health/ready

# Metrics
quarkus.micrometer.enabled=true
quarkus.micrometer.export.prometheus.enabled=true
quarkus.micrometer.export.prometheus.path=/metrics

# OpenAPI / Swagger
quarkus.smallrye-openapi.info-title=Autoflex Backend API
quarkus.smallrye-openapi.info-version=1.0.0
quarkus.smallrye-openapi.info-description=REST API para gerenciamento de produtos, matérias-primas e sugestões de produção
quarkus.swagger-ui.always-include=true
quarkus.swagger-ui.path=/swagger-ui

# Security - API Key for protected routes
# Use environment variable AUTOFLEX_API_KEY in production
autoflex.api.key=${AUTOFLEX_API_KEY:projedata}

# Security Configuration
# Public endpoints (no authentication required)
quarkus.http.auth.permission.public.paths=${API_PATH:/api/v1}/auth/login,${API_PATH:/api/v1}/auth/refresh,${API_PATH:/api/v1}/health,${API_PATH:/api/v1}/q/openapi,${API_PATH:/api/v1}/swagger-ui,${API_PATH:/api/v1}/products/*,${API_PATH:/api/v1}/raw-materials/*,${API_PATH:/api/v1}/production/*,${API_PATH:/api/v1}/production-suggestions,${API_PATH:/api/v1}/productions/*
quarkus.http.auth.permission.public.policy=permit

# Protected endpoints (require authentication) - temporarily disabled for backward compatibility
# quarkus.http.auth.permission.authenticated.paths=${API_PATH:/api/v1}/products/*,${API_PATH:/api/v1}/raw-materials/*,${API_PATH:/api/v1}/production/*
# quarkus.http.auth.permission.authenticated.policy=authenticated

# Allow OPTIONS for CORS preflight
quarkus.http.auth.permission.cors.paths=${API_PATH:/api/v1}/*
quarkus.http.auth.permission.cors.policy=permit
quarkus.http.auth.permission.cors.methods=OPTIONS
